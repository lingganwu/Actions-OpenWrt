name: RedMi-AX6000-OpenWrt-build

on:
  schedule:
    - cron: '0 18 */3 * *'
  workflow_dispatch:
    inputs:
      branch:
        description: '选择分支 (推荐 23.05)'
        required: true
        default: 'openwrt-23.05'
        type: choice
        options:
          - openwrt-23.05
          - master

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout Runner
      uses: actions/checkout@v4

    # 1. 基础清理
    - name: Free Disk Space
      run: |
        echo "Cleaning disk..."
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo docker image prune -a -f
        sudo apt-get -qq clean
        df -hT

    - name: Prepare Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/*
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
        gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev swig qemu-utils upx
        sudo timedatectl set-timezone "$TZ"

    # 2. 拉取官方源码
    - name: Clone Source
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ inputs.branch || 'openwrt-23.05' }}
        path: openwrt

    # 3. 更新基础源
    - name: Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 4. 生成配置 (严格模式：使用 echo 单行写入，防止 YAML 缩进错误)
    - name: Generate Config
      run: |
        cd openwrt
        rm -f .config
        
        # --- A. 锁定机型 (Redmi AX6000) ---
        echo "CONFIG_TARGET_mediatek=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic_DEVICE_xiaomi_redmi-router-ax6000=y" >> .config
        
        # --- B. 必备工具 (curl/wget/ca) ---
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_wget-ssl=y" >> .config
        echo "CONFIG_PACKAGE_ca-bundle=y" >> .config
        echo "CONFIG_PACKAGE_ca-certificates=y" >> .config
        echo "CONFIG_PACKAGE_libustream-openssl=y" >> .config
        echo "CONFIG_PACKAGE_openssl-util=y" >> .config
        
        # --- C. 性能优化 (硬件加速 + 负载均衡) ---
        echo "CONFIG_PACKAGE_kmod-nft-offload=y" >> .config
        echo "CONFIG_PACKAGE_irqbalance=y" >> .config
        echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
        
        # 生成默认配置
        make defconfig
        
        # 防错检查：确认机型已选中
        grep -q "CONFIG_TARGET_mediatek_filogic_DEVICE_xiaomi_redmi-router-ax6000=y" .config || exit 1

        # --- D. 个性化设置 (IP/密码/防火墙) ---
        # 修改默认 IP
        sed -i 's/192.168.1.1/192.168.8.1/g' package/base-files/files/bin/config_generate
        
        # 创建启动脚本
        mkdir -p package/base-files/files/etc/uci-defaults
        
        # 定义脚本路径
        FILE="package/base-files/files/etc/uci-defaults/99-custom-settings"
        
        # 使用 echo 逐行写入，绝对稳健
        echo "#!/bin/sh" > $FILE
        echo "echo -e '851129\n851129' | passwd root" >> $FILE
        
        # 拨号设置
        echo "uci set network.wan.proto='pppoe'" >> $FILE
        echo "uci set network.wan.username='637143646974'" >> $FILE
        echo "uci set network.wan.password='888888'" >> $FILE
        
        # 硬件加速
        echo "uci set firewall.defaults.flow_offloading='1'" >> $FILE
        echo "uci set firewall.defaults.flow_offloading_hw='1'" >> $FILE
        
        # WiFi 设置
        echo "uci set wireless.default_radio0.ssid='OpenWrt_2.4G'" >> $FILE
        echo "uci set wireless.default_radio0.key='19851129z'" >> $FILE
        echo "uci set wireless.default_radio0.encryption='psk2'" >> $FILE
        echo "uci set wireless.default_radio1.ssid='OpenWrt_5G'" >> $FILE
        echo "uci set wireless.default_radio1.key='19851129z'" >> $FILE
        echo "uci set wireless.default_radio1.encryption='psk2'" >> $FILE
        echo "uci set wireless.radio0.country='AU'" >> $FILE
        echo "uci set wireless.radio1.country='AU'" >> $FILE
        
        # 防火墙全开 (WAN口入站接受)
        echo "uci set firewall.@zone[1].input='ACCEPT'" >> $FILE
        echo "uci set firewall.@zone[1].forward='REJECT'" >> $FILE
        
        # 提交更改
        echo "uci commit network" >> $FILE
        echo "uci commit wireless" >> $FILE
        echo "uci commit firewall" >> $FILE
        
        # 启动 irqbalance
        echo "/etc/init.d/irqbalance enable" >> $FILE
        echo "exit 0" >> $FILE

    - name: Download Packages
      run: |
        cd openwrt
        make download -j8

    # 5. 编译
    - name: Compile Firmware
      id: compile
      run: |
        cd openwrt
        echo "Compiling..."
        make -j$(nproc) || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Organize Files
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        mkdir -p firmware_final
        find openwrt/bin/targets -name "*sysupgrade.bin" -exec cp {} firmware_final/ \;
        cd firmware_final
        TIME_TAG=$(date +"%Y%m%d")
        BRANCH="${{ inputs.branch }}"
        [ -z "$BRANCH" ] && BRANCH="23.05"
        # 文件名格式：RedMi-AX6000-OpenWrt-build_日期.bin
        for file in *; do mv "$file" "RedMi-AX6000-OpenWrt-build_${BRANCH}_${TIME_TAG}.bin"; done
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
        ls -lh

    # 6. 上传 (官方 Rclone)
    - name: Upload to OneDrive
      if: steps.compile.outputs.status == 'success' && env.RCLONE_CONF != ''
      run: |
        sudo -v ; curl https://rclone.org/install.sh | sudo bash
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF }}" > ~/.config/rclone/rclone.conf
        echo "Uploading..."
        rclone copy ${{ env.FIRMWARE_PATH }} onedrive:/OpenWrt_Builds/
        echo "Upload success!"

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      if: steps.compile.outputs.status == 'success' && !cancelled()
      with:
        tag_name: AX6000_Build_${{ github.run_number }}
        files: ${{ env.FIRMWARE_PATH }}/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
