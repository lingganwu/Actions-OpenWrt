name: AX6000 Passwall (3-Day Loop + OneDrive)

on:
  workflow_dispatch: # 允许手动点击按钮开始
  schedule:
    - cron: '0 18 */3 * *' # 每3天执行一次 (北京时间凌晨02:00)

env:
  REPO_URL: https://github.com/hanwckf/immortalwrt-mt7986
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Prepare Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
        gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev swig qemu-utils
        sudo timedatectl set-timezone "$TZ"
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

    - name: Clone Source (hanwckf/mt7986)
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt

    - name: Add Passwall Feeds
      run: |
        cd openwrt
        # 1. 添加 Passwall 源
        echo "src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main" >> feeds.conf.default
        echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main" >> feeds.conf.default
        
        # 2. 更新并安装
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate Config (AX6000)
      run: |
        cd openwrt
        # 1. 载入 Redmi AX6000 默认配置
        cp defconfig/mt7986-ax6000.config .config
        
        # 2. 强制写入 Passwall 配置
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_ChinaDNS_NG=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall_INCLUDE_SingBox=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y" >> .config
        
        # 3. 生成完整配置
        make defconfig

    - name: Download Packages
      run: |
        cd openwrt
        make download -j8

    - name: Compile Firmware
      id: compile
      run: |
        cd openwrt
        echo "Starting compilation..."
        make -j$(nproc) || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Prepare Files for Upload
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        mkdir -p firmware_final
        # 提取 sysupgrade.bin (刷机包)
        find openwrt/bin/targets -name "*sysupgrade.bin" -exec cp {} firmware_final/ \;
        
        cd firmware_final
        # 重命名增加时间戳
        TIME_TAG=$(date +"%Y%m%d")
        for file in *; do mv "$file" "AX6000_Passwall_${TIME_TAG}_${file}"; done
        
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
        echo "Files to upload:"
        ls -lh

    # --- 方案A: 上传到 OneDrive (如果你配置了 Secret) ---
    - name: Upload to OneDrive
      if: steps.compile.outputs.status == 'success' && env.RCLONE_CONF != ''
      uses: wei/rclone@v1
      env:
        RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
      with:
        # 将文件复制到 OneDrive 的 OpenWrt_Builds 文件夹
        args: copy ${{ env.FIRMWARE_PATH }} onedrive:/OpenWrt_Builds/

    # --- 方案B: 上传到 GitHub Release (保底方案) ---
    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      if: steps.compile.outputs.status == 'success' && !cancelled()
      with:
        tag_name: AX6000_Build_${{ github.run_number }}
        files: ${{ env.FIRMWARE_PATH }}/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
